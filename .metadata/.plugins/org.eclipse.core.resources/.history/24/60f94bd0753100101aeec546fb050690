package com.myy803.traineeship_app.service;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;

import com.myy803.traineeship_app.domainmodel.Student;
import com.myy803.traineeship_app.domainmodel.TraineeshipPosition;
import com.myy803.traineeship_app.mapper.StudentMapper;
import com.myy803.traineeship_app.mapper.TraineeshipPositionMapper;

@Service
@Transactional
public class StudentServiceImpl implements StudentService {
    
    private final StudentMapper studentMapper;
    private final TraineeshipPositionMapper positionMapper;

    @Autowired
    public StudentServiceImpl(StudentMapper studentMapper,
                            TraineeshipPositionMapper positionMapper) {
        this.studentMapper = studentMapper;
        this.positionMapper = positionMapper;
    }

    @Override
    public String getStudentDashboard() {
        return "student/dashboard";
    }

    @Override
    public String retrieveProfile(Model model) {
        String username = getCurrentUsername();
        Student student = studentMapper.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        
        // Ensure all required fields are populated
        if(student.getYearOfStudies() == null) {
            student.setYearOfStudies(1); // default value
        }
        
        model.addAttribute("student", student);
        return "student/profile";
    }

    @Override
    public String saveProfile(@ModelAttribute("student") Student student, Model model) {
        try {
            // Get the existing student to preserve any fields not in the form
            Student existingStudent = studentMapper.findByUsername(student.getUsername())
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
            
            // Update only the fields that are in the form
            existingStudent.setStudentName(student.getStudentName());
            existingStudent.setAM(student.getAM());
            existingStudent.setDepartment(student.getDepartment());
            existingStudent.setYearOfStudies(student.getYearOfStudies());
            existingStudent.setAvgGrade(student.getAvgGrade());
            
            studentMapper.save(existingStudent);
            
            // Add success message and redirect to profile page
            model.addAttribute("successMessage", "Profile updated successfully!");
            return "redirect:/student/profile";
        } catch (Exception e) {
            model.addAttribute("errorMessage", "Error updating profile: " + e.getMessage());
            return "student/profile";
        }
    }

    @Override
    public String initLogbook(Model model) {
        String username = getCurrentUsername();
        Student student = studentMapper.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        
        model.addAttribute("position", student.getAssignedTraineeship());
        
        model.addAttribute("student", student);
        
        return "student/logbook"; 
    }

    @Override
    public String saveLogbook(@ModelAttribute("position") TraineeshipPosition position, Model model) {
        try {
            positionMapper.save(position);
            model.addAttribute("successMessage", "Logbook updated successfully");
            return "student/logbook";
        } catch (Exception e) {
            model.addAttribute("errorMessage", "Error updating logbook: " + e.getMessage());
            return "student/logbook";
        }
    }

    private String getCurrentUsername() {
        return SecurityContextHolder.getContext().getAuthentication().getName();
    }
    
    @Override
    public String applyForTraineeship(Model model) {
        String username = getCurrentUsername();
        Student student = studentMapper.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        
        model.addAttribute("student", student);
        return "student/apply-traineeship"; // Updated template name
    }

    @Override
    public String submitApplication(Model model) {
        String username = getCurrentUsername();
        Student student = studentMapper.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        
        student.setLookingForTraineeship(true);
        studentMapper.save(student);
        
        model.addAttribute("successMessage", "Application submitted successfully!");
        return "redirect:/student/application-status";
    }
    
    @Override
    public String getApplicationStatus(Model model) {
        String username = getCurrentUsername();
        Student student = studentMapper.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        
        model.addAttribute("isLooking", student.isLookingForTraineeship());
        model.addAttribute("position", student.getAssignedTraineeship());
        model.addAttribute("student", student);
        
        return "student/application-status";
    }
}